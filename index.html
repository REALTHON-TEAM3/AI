<!DOCTYPE html>
<html>
<body>
<h2>OpenAI Realtime WebRTC Demo</h2>
<div id="output" style="font-size:20px; white-space:pre-line;"></div>

<script>
const API_KEY = "YOUR_API_KEY";   // â† ì—¬ê¸°ì— ë„£ê¸°

const log = (msg) => {
  document.getElementById("output").innerHTML += msg + "<br>";
};

async function start() {
  const mic = await navigator.mediaDevices.getUserMedia({ audio: true });
  const pc = new RTCPeerConnection();

  mic.getTracks().forEach((t) => pc.addTrack(t, mic));

  let dataChannel = pc.createDataChannel("oai-events");

  dataChannel.onmessage = (e) => {
    const msg = JSON.parse(e.data);

    // ì‹¤ì‹œê°„ í…ìŠ¤íŠ¸ ìŠ¤íŠ¸ë¦¼
    if (msg.type === "response.output_text.delta") {
      const text = msg.delta;
      log("ğŸ“ " + text);

      // Python ì„œë²„ë¡œ ì „ë‹¬
      fetch("http://localhost:8000/process", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({ text }),
      });
    }
  };

  const offer = await pc.createOffer();
  await pc.setLocalDescription(offer);

  const resp = await fetch(
    "https://api.openai.com/v1/realtime?model=gpt-4o-realtime-preview",
    {
      method: "POST",
      headers: {
        "Authorization": `Bearer ${API_KEY}`,
        "Content-Type": "application/sdp",
        "OpenAI-Beta": "realtime=v1"
      },
      body: offer.sdp
    }
  );

  const answer = await resp.text();
  await pc.setRemoteDescription({ type: "answer", sdp: answer });

  log("ğŸ‰ Connected! Speak now...");
}

start();
</script>
</body>
</html>
